<input type="hidden" name="daysEachMonths" value="{{stringify daysEachMonths}}" />

<div x-data="initDueMonthlyData()">
	<div class="mt-3 pb-3">
		<div class="d-flex align-items-center justify-content-end">
			<a
				class="btn btn-primary"
				data-bs-toggle="collapse"
				href="#collapse-jimpitan-statistic-filter"
				role="button"
				aria-expanded="true"
				aria-controls="collapse-jimpitan-statistic-filter"
			>
				<i class="bi bi-funnel me-1"></i>
				Filter Riwayat
			</a>
		</div>

		<div class="collapse show" id="collapse-jimpitan-statistic-filter">
			<div class="mt-3 card card-body">
				<form class="row g-3 mb-0">
					<div class="col-6 col-md-2">
						<label for="rw" class="form-label">
							RW
						</label>
						<select
							class="form-control select2
								{{echoif
									(lookup errors.fieldErrors 'community_assoc_id')
									'is-invalid'
								}}"
							name="community_assoc_id"
							width="100%"
						>
							<option value=""></option>
							{{#each communityAssocs as |communityAssoc|}}
								<option value="{{communityAssoc.id}}">
									{{communityAssoc.name}}
								</option>
							{{/each}}
						</select>
					</div>
					<div class="col-6 col-md-2">
						<label for="resident_assoc_id" class="form-label">
							RT
						</label>
						<select
							class="form-select"
							name="resident_assoc_id"
							aria-label="Pilih RT"
						>
							<option value=""></option>
						</select>
					</div>
				</form>
			</div>
		</div>
	</div>

	<div class="table-responsive">
		<canvas id="jimpitan-statistics"></canvas>
	</div>
</div>

{{#content "scripts" mode="append"}}
<script type="text/javascript" src="/plugins/select2/js/select2.full.min.js"></script>
<script type="text/javascript">
	function initDueMonthlyData() {
		return {
			daysEachMonths: JSON.parse($('[name="daysEachMonths"]').val()),
			init() {
				$('[name="community_assoc_id"]').select2({ placeholder: "Pilih RW", allowClear: true });
				$('[name="resident_assoc_id"]').select2({ placeholder: "Pilih RT", allowClear: true });
				$('[name="community_assoc_id"]').change(function () {
					$('[name="resident_assoc_id"]').val("").trigger("change");

					const communityAssocId = $(this).val();
					const residentAssocsApiUrl = `/api/community-assocs/${communityAssocId}/resident-assocs`;
					select2AjaxHandler('[name="resident_assoc_id"]', residentAssocsApiUrl, {
						placeholder: "Pilih RT",
						allowClear: true,
					});
				});

				const ctx = document.getElementById("jimpitan-statistics");
				const labels = this.daysEachMonths.map((month) => month.month.replace("20", ""));

				new Chart(ctx, {
					type: "bar",
					data: {
						labels,
						datasets: [
							{
							label: "RT 04",
							data: [12000, 19000, 3000, 5000, 2000, 3000],
							borderWidth: 1,
							backgroundColor: "rgba(21, 128, 64, 0.1)",
							},
							{
							label: "RT 05",
							data: [19000, 3000, 5000, 12000, 2000, 3000],
							borderWidth: 1,
							},
						],
					},
					options: {
						scales: {
							y: { beginAtZero: true },
						},
					},
				});
			},
		};
	}
</script>
{{/content}}